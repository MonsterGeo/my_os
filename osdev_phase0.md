## 编译GCC

在本教程中，我们将升级您的系统GCC至最新版本。这有助于构建GCC交叉编译器，因为建议使用相同的编译器版本来构建交叉编译器。经过适当注意，您无需重新启动新的系统编译器，但这存在风险，并可能引发问题。您应使用与系统编译器和交叉编译器相同的重大编译器版本。


## 引入


编译器通过称为“自举”的过程进行升级。最初，您拥有一个旧系统的编译器，该编译器生成的代码较慢，且不支持所有新的语言特性。随后，您使用这个旧系统编译器来构建编译器的新版本，希望旧编译器能够成功构建新编译器（即旧编译器支持所有必要的特性）。这样会产生一个新编译器，该编译器生成的代码较快且支持所有新特性，但编译器本身的运行速度较慢，因为它是由一个生成慢代码的编译器编译而成的。此外，新编译器可能存在缺陷，原因可能是旧编译器存在缺陷，或者新编译器版本本身包含错误。

下一步是使用您新开发的慢速编译器，该编译器能够生成高效的代码，然后再次构建新的编译器。这样就能够产生一个生成高效代码的快速编译器。然而，我们首次构建的编译器可能存在错误，而使用它构建的编译器也可能存在缺陷。我们需要验证我们新的快速编译器生成高效代码的正确性。

为了解决该问题，我们第三次构建编译器。一旦我们使用第二个编译器构建了第三个编译器，它应该产生与第一个编译器构建第二个编译器时完全相同的输出，因为在这两次构建中，我们都使用了生成快速代码并使用相同源代码的编译器。编译器构建系统随后将验证第二个和第三个编译器是否相同，这为您对自举过程提供了信心。如果第二个和第三个编译器不相同，则自举失败，您遇到了编译器错误。自举过程所需时间是构建普通编译器的三倍，但它确保了您的工具链稳定性。

最后一步是运行编译器测试套件，以便验证其是否正确工作。
请注意，如果您使用GCC 4.4来构建GCC 4.8交叉编译器，可能会出现相同的问题。因此，建议使用GCC 4.8来构建GCC 4.8交叉编译器，以确信不会出现此类问题。您无法引导交叉编译器，因为它不生成适用于本地操作系统的程序。

### 我是否需要引导程序？


若系统编译器与您希望构建的编译器版本属于同一主版本号（例如，您拥有4.6.2版本，但希望构建4.6.3版本），则无需进行引导编译。主版本号之间的次版本号通常具有很高的兼容性。在某些情况下，您可能无需引导编译即可构建另一主版本（例如，使用4.6.3版本构建4.7.3版本），但这种方式可能无法生成理想的编译器。随着编译器版本差异的增大，您很可能遇到编译问题。每个主版本的编译器发布通常都能够通过引导编译来构建其后续版本。如果您具备足够的耐心，可以寻获一台配备非常老旧Linux系统及非常老旧GCC版本的计算机，并通过逐次迭代升级少数几个主版本编译器的方式，引导编译直至达到最新的GCC版本。此外，您也可能通过其他途径升级系统编译器。

### 我需要哪个编译器版本？

最新版的GCC被推荐使用，因为它是最新的且功能最强大的版本。目前，GCC 4.9.2是最新发布版。我们建议您使用最新的编译器版本来构建交叉编译器。您也可以使用较旧版本，因为它们通常表现良好。如果您的本地系统编译器不是特别陈旧（至少GCC 4.6.0），您可能希望避免麻烦，只需选择最新的次要版本（例如，如果您的系统编译器是4.6.1，则选择4.6.3）作为您的交叉编译器。在这种情况下，您无需进行引导，可以直接开始构建GCC交叉编译器。

您可以通过调用以下命令来查看当前编译器的版本：


```shell
gcc --version
```

如果您具备耐心并希望构建最新且功能强大的交叉编译器，您将需要在构建GCC交叉编译器之前，首先引导您的系统编译器。

### 是否需要新的Binutils?

这当然不会造成伤害，但如果您的Binutils版本不是过于陈旧的话，它应该足以适用于您新系统的编译器。您可以通过调用以下命令来查看当前Binutils的版本：

```shell
ld --version

```

您可能至少需要Binutils 2.22，或者更理想的是最新的2.25版本。(最新的debian已经是2.44了)

## 编译准备阶段

构建GCC需要如下工具：

+ Unix-like环境
+ 足够的内存和硬盘空间
+ GCC
+ G++
+ Make
+ Bison
+ Flex
+ GMP
+ MPFR
+ MPC
+ Texinfo
+ ISL

### 安装依赖项

我们选用Debian系统，执行如下命令来安装上述程序

```shell

sudo apt install bison flex libgmp3-dev libmpc-dev libmpfr-dev texinfo libisl-dev

```

其他系统请参考[Buliding_GCC](https://wiki.osdev.org/Building_GCC)

注意：已知Texinfo的5.x（或更高）版本与当前Binutils 2.23.2版本（及更早版本）不兼容。您可以使用makeinfo --version命令检查当前版本。如果您的版本过于新，并且在构建过程中遇到问题，您需要使用Binutils 2.24版本（或更高版本）或者安装一个较旧的Texinfo版本——可能通过从源码构建——并在Binutils构建之前和期间将其添加到您的PATH中。

注意：GCC在5.x版本中已停止对CLooG的支持[8]，许多发行版也已删除CLooG软件包（例如，Gentoo在2022年12月）。

注意：GCC至少需要ISL版本0.15。

注意：如果您正在使用Cygwin，建议安装libintl-devel软件包（没有这个软件包，我无法构建交叉编译器）。

### 下载源码

注意事项：下载的源代码需要放在合适的目录，比如$HOME/src:

你可以在[Binutils](https://gnu.org/software/binutils/)下载到所需的Binutils版本。

在[GCC](https://gnu.org/software/gcc/)下载到所需的gcc版本。

注意的是：所采用的版本号方案是每个句点分隔一个完整数字，即Binutils 2.20.0比2.9.0更新。对于尚未遇到过这种（相当常见）版本号方案的观察者而言，在查看按字母数字顺序排列的软件包列表时，可能会感到困惑：列表底部的文件并非最新版本。获取最新版本的一种简便方法是按最后修改日期排序，并滚动至列表底部。

## 构建

您需要决定将新的编译器安装在哪里。替换当前系统编译器并将其安装到系统目录中可能非常危险。您还需要决定是否将新编译器全局安装或仅为您安装。如果您只想为自己安装（推荐），通常将安装到$HOME/opt/gcc-x.y.z是一个不错的选择。如果您想全局安装，通常将安装到/usr/local/gcc-x.y.z是一个不错的选择。
请注意，我们通常从源目录树构建所有内容，这被视为良好的实践。某些软件包仅支持在外部构建，某些仅支持内部构建，而某些两者都支持（但可能不会提供广泛的make检查）。在源目录树内构建GCC通常会失败，至少对于较旧版本来说是这样。

由于构建可能需要很长时间，建议使用make的"-jN"选项。这将允许make使用多个线程来编译程序，从而大大加快速度。用数字替换N；一个良好的指导原则是CPU核心数加一。因此，对于4核心CPU，您将希望使用

```shell

make -j5

```


执行下述命令设置gcc的环境变量

```shell
export PREFIX="$HOME/opt/gcc-x.y.z"
```

对于Binutils，我们可以这样安装，实际安装的时候请注意路径,src是源代码文件夹地址

```shell
cd $HOME/src
mkdir build-binutils
cd build-binutils
../binutils-x.y.z/configure --prefix="$PREFIX" --disable-nls --disable-werror
make
make install
```


而gcc这样安装

```shell
cd $HOME/src


# If you wish to build these packages as part of GCC:
mv libiconv-x.y.z gcc-x.y.z/libiconv # Mac OS X users
mv gmp-x.y.z gcc-x.y.z/gmp
mv mpfr-x.y.z gcc-x.y.z/mpfr
mv mpc-x.y.z gcc-x.y.z/mpc

# Or in new GCC versions, you can ask gcc to download the prerequisites
cd gcc-x.y.z
./contrib/download_prerequisites
cd $HOME/src # Returning the main src folder

mkdir build-gcc
cd build-gcc
../gcc-x.y.z/configure --prefix="$PREFIX" --disable-nls --enable-languages=c,c++
make
make install
```

--disable-nls与上述Binutils中的用法相同。
--enable-languages指示GCC不要编译它所支持的其他语言前端，而仅编译C和C++。即使您不打算使用C++来构建您的操作系统，您也将在以后需要它来移植GCC。
--disable-bootstrap指示编译器不要使用当前系统编译器进行自举。这会导致编译速度大大加快，但如果当前编译器和新编译器在版本上差异过大，您可能会得到一个稳定性较差的编译器或出现奇特的错误。
构建和自举GCC可能需要相当长的时间，因此请放松并享受您即将使用最新和最优秀的GNU编译器集合版本。
在运行make install并安装新编译器之前，如果您有额外的耐心，请阅读官方测试说明并测试您的编译器是否存在缺陷。

## 使用您的新编译器

使用下述命令查看版本

```shell
$HOME/opt/gcc-x.y.z/bin/gcc --version
```

或者，使用如下命令把gcc添加到环境变量

```shell
export PATH="$HOME/opt/gcc-x.y.z/bin:$PATH"
```

此命令将为当前shell会话添加您的新的编译器到PATH环境变量中。如果您希望永久使用它，请将PATH命令添加到您的~/.profile配置shell脚本或类似文件中。有关更多信息，请查阅您的shell文档。